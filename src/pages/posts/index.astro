---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatDate, getYear } from '../../utils/date';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
  const year = getYear(post.data.pubDate);
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);
---

<BaseLayout title="All Posts" description="All blog posts">
  <h1 class="text-3xl font-bold text-[#282728] mb-8">All Posts</h1>

  {years.map(year => (
    <section class="mb-12">
      <h2 class="text-xl font-semibold text-[#666] mb-4">{year}</h2>
      <ul class="space-y-4">
        {postsByYear[year].map(post => (
          <li class="flex gap-4 items-baseline">
            <time
              datetime={post.data.pubDate.toISOString()}
              class="text-[#999] text-sm w-20 flex-shrink-0"
            >
              {formatDate(post.data.pubDate).replace(`, ${year}`, '')}
            </time>
            <a
              href={`/posts/${post.slug}`}
              class="text-[#282728] hover:text-accent transition-colors"
            >
              {post.data.title}
            </a>
          </li>
        ))}
      </ul>
    </section>
  ))}

  {posts.length === 0 && (
    <p class="text-[#666]">No posts yet. Check back soon!</p>
  )}
</BaseLayout>
